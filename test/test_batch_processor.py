import sys
import os
import time

# å°†é¡¹ç›®æ ¹ç›®å½•æ·»åŠ åˆ°Pythonè·¯å¾„ä¸­
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from donyan_utils.config import BatchConfig
from donyan_utils.batch_processor import parallel_batch_processor, simple_parallel_map

# ä½¿ç”¨ç¤ºä¾‹å’Œæµ‹è¯•ä»£ç 
if __name__ == "__main__":
    # ç¤ºä¾‹1: æ¨¡æ‹ŸAPIè°ƒç”¨
    def mock_api_call(task_id):
        import random
        time.sleep(random.uniform(0.1, 0.5))  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        
        # æ¨¡æ‹Ÿ10%çš„å¤±è´¥ç‡
        if random.random() < 0.1:
            raise Exception(f"APIè°ƒç”¨å¤±è´¥ - ä»»åŠ¡{task_id}")
        
        return f"ä»»åŠ¡{task_id}å®Œæˆï¼Œç»“æœ: {task_id * 100}"
    
    print("ğŸ§ª æµ‹è¯•ç¤ºä¾‹1: æ¨¡æ‹ŸAPIæ‰¹é‡è°ƒç”¨")
    tasks = list(range(1, 21))  # 20ä¸ªä»»åŠ¡
    config = BatchConfig(
        max_workers=5,
        rate_limit_per_minute=300,
        max_retries=3
    )
    
    result = parallel_batch_processor(tasks, mock_api_call, config)
    print(f"æˆåŠŸç»“æœæ•°é‡: {len(result['successful_results'])}")
    print(f"å¤±è´¥ä»»åŠ¡æ•°é‡: {len(result['failed_tasks'])}")
    
    print("\n" + "="*60)
    
    # ç¤ºä¾‹2: ç®€å•çš„æ•°å­¦è®¡ç®—
    def square_number(n):
        return n ** 2
    
    print("ğŸ§ª æµ‹è¯•ç¤ºä¾‹2: ç®€å•å¹¶è¡Œè®¡ç®—")
    numbers = list(range(10))
    squared_results = simple_parallel_map(numbers, square_number, max_workers=4)
    print(f"åŸå§‹æ•°å­—: {numbers}")
    print(f"å¹³æ–¹ç»“æœ: {squared_results}") 